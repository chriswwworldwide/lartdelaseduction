name: Claude Full Repository Review

on:
  workflow_dispatch:   # Manual launch from Actions tab

permissions:
  contents: read

jobs:
  full_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq tree

      - name: Create repository summary
        run: |
          echo "ðŸ—‚ï¸ Repository tree (depth 3):" > repo_summary.txt
          tree -L 3 -I '.git|node_modules|venv|__pycache__|dist|build' >> repo_summary.txt
          echo "" >> repo_summary.txt
          echo "Total tracked files:" $(git ls-files | wc -l) >> repo_summary.txt

      - name: Gather representative code snippets
        run: |
          echo "Collecting representative snippets..." > snippets.txt
          git ls-files '*.*' | grep -vE '\.(png|jpg|jpeg|gif|svg|mp4|zip|lock|env|ico)$' | head -20 | while read FILE; do
            echo "---- $FILE ----" >> snippets.txt
            head -n 80 "$FILE" >> snippets.txt
            echo "" >> snippets.txt
          done

      - name: Ask Claude for architecture review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          SUMMARY=$(cat repo_summary.txt | sed 's/"/\\"/g')
          SNIPPETS=$(cat snippets.txt | sed 's/"/\\"/g')

          echo "Requesting full repository architecture review..."
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "content-type: application/json" \
            -d "{
                  \"model\": \"claude-3-5-sonnet-latest\",
                  \"max_tokens\": 2000,
                  \"messages\": [
                    {\"role\": \"user\", \"content\": \"Here is an overview of the entire repositoryâ€™s structure and representative code snippets. Please analyze this project and produce:\\n\\n1. A high-level understanding of the websiteâ€™s purpose.\\n2. A recommended folder/file architecture for better scalability, readability, and maintainability.\\n3. Specific folder groupings (e.g., components, assets, pages, utilities, styles, API endpoints).\\n4. Any suggested naming conventions or reorganization steps.\\n\\nRepository structure:\\n$SUMMARY\\n\\nRepresentative source snippets:\\n$SNIPPETS\"}
                  ]
                }" | jq -r '.content[0].text')

          echo "$RESPONSE" > architecture_review.txt
          echo "-------------------------------------------"
          echo "$RESPONSE"
          echo "-------------------------------------------"

      - name: Upload architecture review artifact
        uses: actions/upload-artifact@v4
        with:
          name: Claude-Architecture-Review
          path: architecture_review.txt