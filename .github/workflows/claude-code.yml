name: Claude Code Review (Direct API)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history to avoid "bad object" errors

      - name: Install jq JSON parser
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run Claude code review through API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "üîç Gathering changed files..."
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          echo "Files changed:"
          echo "$FILES"

          echo ""
          echo "üß† Sending files to Claude for review..."
          for FILE in $FILES; do
            CONTENT=$(head -c 12000 "$FILE" | sed 's/"/\\"/g')
            echo "Reviewing $FILE ..."
            RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "content-type: application/json" \
              -d "{
                    \"model\": \"claude-3-5-sonnet-latest\",
                    \"max_tokens\": 400,
                    \"messages\": [
                      {\"role\": \"user\", \"content\": \"Please review this file for potential improvements or issues. Filename: $FILE\\n\\n$CONTENT\"}
                    ]
                  }" | jq -r '.content[0].text')
            echo ""
            echo "üí¨ Claude's feedback for $FILE:"
            echo "$RESPONSE"
            echo "-----------------------------------------------"
          done