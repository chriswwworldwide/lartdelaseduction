name: Claude Full Repository Review

on:
  workflow_dispatch:  # ðŸ‘ˆ manual trigger from Actions tab

jobs:
  full_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq JSON parser
        run: sudo apt-get update && sudo apt-get install -y jq tree

      - name: Create file tree summary
        run: |
          echo "ðŸ—‚ï¸ Repository structure:" > repo_summary.txt
          tree -L 3 -I '.git|node_modules|venv|__pycache__' >> repo_summary.txt
          echo "" >> repo_summary.txt
          echo "Total files:" $(git ls-files | wc -l) >> repo_summary.txt

      - name: Run full Claude architecture review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Gather a compact combined code sample (avoid sending huge binaries)
          echo "Gathering representative snippets..."
          head -n 200 $(git ls-files '*.*' | grep -vE '\.(png|jpg|jpeg|gif|zip|lock|env)$' | head -20) > sample_snippets.txt

          SUMMARY=$(cat repo_summary.txt | sed 's/"/\\"/g')
          SNIPPET=$(cat sample_snippets.txt | sed 's/"/\\"/g')

          echo "Requesting Claude architecture review..."
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "content-type: application/json" \
            -d "{
                  \"model\": \"claude-3-5-sonnet-latest\",
                  \"max_tokens\": 1500,
                  \"messages\": [
                    {\"role\": \"user\", \"content\": \"Here is the repository structure and representative file content. Please analyze the whole projectâ€™s organization and propose a clean, scalable file/folder architecture with explanations for where each file should live.\\n\\n$SUMMARY\\n\\nRepresentative code snippets:\\n$SNIPPET\"}
                  ]
                }" | jq -r '.content[0].text')

          echo "AI Architectural Review ---------------------------------------"
          echo "$RESPONSE"
          echo "--------------------------------------------------------------"

          echo "$RESPONSE" > architecture_review.txt

      - name: Upload review artifact
        uses: actions/upload-artifact@v4
        with:
          name: Claude-Architecture-Review
          path: architecture_review.txt